<?php
/*
  Template Name: Amazon
 */

$ItemAttributes = array(
    'Actor' => 'Actor',
    'Address1' => 'Address',
    'Address2' => 'Address',
    'Address3' => 'Address',
    'AmazonMaximumAge' => 'Maximum Age',
    'AmazonMinimumAge' => 'Minimum Age',
    'Amount' => 'Amount',
    'ApertureModes' => 'Aperture Modes',
    'Artist' => 'Artist',
    'ASIN' => 'ASIN',
    'AspectRatio' => 'Aspect Ratio',
    'AudienceRating' => 'Audience Rating',
    'AudioFormat' => 'Audio Format',
    'Author' => 'Author',
    'BackFinding' => 'Back Finding',
    'BandMaterialType' => 'Band Material Type',
    'Batteries' => 'Batteries',
    'BatteriesIncluded' => 'Batteries Included',
    'BatteryDescription' => 'Battery Description',
    'BatteryType' => 'Battery Type',
    'BezelMaterialType' => 'Bezel Material Type',
    'Binding' => 'Binding',
    'Brand' => 'Brand',
    'CalendarType' => 'Calendar Type',
    'CameraManualFeatures' => 'Camera Manual Features',
    'CaseDiameter' => 'Case Diameter',
    'CaseMaterialType' => 'Case Material Type',
    'CaseThickness' => 'Case Thickness',
    'CaseType' => 'Case Type',
    'CDRWDescription' => 'CDRW Description',
    'ChainType' => 'Chain Type',
    'City' => 'City',
    'ClaspType' => 'Clasp Type',
    'ClothingSize' => 'Clothing Size',
    'Color' => 'Color',
    'Compatibility' => 'Compatibility',
    'CPUManufacturer' => 'CPU Manufacturer',
    'CPUSpeed' => 'CPU Speed',
    'CPUType' => 'CPU Type',
    'Creator' => 'Creator',
    'CurrencyCode' => 'Currency Code',
    'Day' => 'Day',
    'DelayBetweenShots' => 'Delay Between Shots',
    'Department' => 'Department',
    'DetailPageURL' => 'Detail Page URL',
    'DeweyDecimalNumber' => 'Dewey Decimal Number',
    'DialColor' => 'Dial Color',
    'DialWindowMaterialType' => 'Dial Window Material Type',
    'DigitalZoom' => 'Digital Zoom',
    'Director' => 'Director',
    'DisplaySize' => 'Display Size',
    'DVDLayers' => 'DVD Layers',
    'DVDRWDescription' => 'DVDRW Description',
    'DVDSides' => 'DVD Sides',
    'EAN' => 'EAN',
    'Edition' => 'Edition',
    'EpisodeSequence' => 'Episode Sequence',
    'ESRBAgeRating' => 'ESRB Age Rating',
    'ExternalDisplaySupportDescription' => 'External Display Support Description',
    'FabricType' => 'Fabric Type',
    'FaxNumber' => 'Fax Number',
    'Feature' => 'Feature',
    'FirstIssueLeadTime' => 'First Issue Lead Time',
    'FlavorName' => 'Flavor Name',
    'FloppyDiskDriveDescription' => 'Floppy Disk Drive Description',
    'Format' => 'Format',
    'FormattedPrice' => 'Formatted Price',
    'GemType' => 'Gem Type',
    'GemTypeSetElement' => 'Gem Type Set Element',
    'Genre' => 'Genre',
    'GolfClubFlex' => 'Golf Club Flex',
    'GolfClubLoft' => 'Golf Club Loft',
    'GraphicsCardInterface' => 'Graphics Card Interface',
    'GraphicsDescription' => 'Graphics Description',
    'GraphicsMemorySize' => 'Graphics Memory Size',
    'HardDiskCount' => 'Hard Disk Count',
    'HardDiskSize' => 'Hard Disk Size',
    'HasAutoFocus' => 'Has Auto Focus',
    'HasBurstMode' => 'Has Burst Mode',
    'HasInCameraEditing' => 'Has In Camera Editing',
    'HasRedEyeReduction' => 'Has Red Eye Reduction',
    'HasSelfTimer' => 'Has Self Timer',
    'HasTripodMount' => 'Has Tripod Mount',
    'HasVideoOut' => 'Has Video Out',
    'HasViewfinder' => 'Has Viewfinder',
    'Height' => 'Height',
    'Hours' => 'Hours',
    'HoursOfOperation' => 'Hours Of Operation',
    'IncludedSoftware' => 'Included Software',
    'IncludesMp3Player' => 'Includes MP3 Player',
    'Ingredients' => 'Ingredients',
    'IngredientsSetElement' => 'Ingredients Set Element',
    'IsAutographed' => 'Is Autographed',
    'IsEligibleForTradeIn' => 'Is Eligible For Trade In',
    'ISBN' => 'ISBN',
    'IngredientsSetElement' => 'Ingredients Set Element',
    'IsEmailNotifyAvailable' => 'Is Email Notify Available',
    'IsFragile' => 'Is Fragile',
    'IsLabCreated' => 'Is Lab Created',
    'IsMemorabilia' => 'Is Memorabilia',
    'ISOEquivalent' => 'ISO Equivalent',
    'IssuesPerYear' => 'Issues Per Year',
    'KeyboardDescription' => 'Keyboard Description',
    'Keywords' => 'Keywords',
    'Label' => 'Label',
    'LegalDisclaimer' => 'Legal Disclaimer',
    'Length' => 'Length',
    'LongSynopsis' => 'Long Synopsis',
    'LineVoltage' => 'Line Voltage',
    'MacroFocusRange' => 'Macro Focus Range',
    'MagazineType' => 'Magazine Type',
    'Manufacturer' => 'Manufacturer',
    'ManufacturerLaborWarrantyDescription' => 'Manufacturer Labor Warranty Description',
    'ManufacturerMaximumAge' => 'Manufacturer Maximum Age',
    'MaterialTypeSetElement' => 'Material Type Set Element',
    'ManufacturerMinimumAge' => 'Manufacturer Minimum Age',
    'ManufacturerPartsWarrantyDescription' => 'Manufacturer Parts Warranty Description',
    'MaterialType' => 'Material Type',
    'MaximumAperture' => 'Maximum Aperture',
    'MaximumColorDepth' => 'Maximum Color Depth',
    'MaximumFocalLength' => 'Maximum Focal Length',
    'MaximumHighResolutionImages' => 'Maximum High Resolution Images',
    'MaximumHorizontalResolution' => 'Maximum Horizontal Resolution',
    'MaximumLowResolutionImages' => 'Maximum Low Resolution Images',
    'MaximumResolution' => 'Maximum Resolution',
    'MaximumShutterSpeed' => 'Maximum Shutter Speed',
    'MaximumVerticalResolution' => 'Maximum Vertical Resolution',
    'MaximumWeightRecommendation' => 'Maximum Weight Recommendation',
    'MemorySlotsAvailable' => 'Memory Slots Available',
    'Message' => 'Message',
    'MetalStamp' => 'Metal Stamp',
    'MetalType' => 'Metal Type',
    'MiniMovieDescription' => 'Mini Movie Description',
    'MinimumFocalLength' => 'Minimum FocalLength',
    'MinimumShutterSpeed' => 'Minimum ShutterSpeed',
    'Model' => 'Model',
    'ModemDescription' => 'Modem Description',
    'MonitorSize' => 'Monitor Size',
    'MonitorViewableDiagonalSize' => 'Monitor Viewable DiagonalSize',
    'MouseDescription' => 'Mouse Description',
    'MPN' => 'MPN',
    'Name' => 'Name',
    'NativeResolution' => 'Native Resolution',
    'Neighborhood' => 'Neighborhood',
    'NetworkInterfaceDescription' => 'Network Interface Description',
    'NotebookDisplayTechnology' => 'Notebook Display Technology',
    'NotebookPointingDeviceDescription' => 'Notebook Pointing Device Description',
    'NumberOfDiscs' => 'Number Of Discs',
    'NumberOfIssues' => 'Number Of Issues',
    'NumberOfItems' => 'Number Of Items',
    'NumberOfPages' => 'Number Of Pages',
    'NumberOfPearls' => 'Number Of Pearls',
    'NumberOfRapidFireShots' => 'Number Of Rapid Fire Shots',
    'NumberOfStones' => 'Number Of Stones',
    'NumberOfTracks' => 'Number Of Tracks',
    'OpticalZoom' => 'Optical Zoom',
    'OriginalAirDate' => 'Original Air Date',
    'OriginalReleaseDate' => 'Original Release Date',
    'PearlLustre' => 'Pearl Lustre',
    'PearlMinimumColor' => 'Pearl Minimum Color',
    'PearlShape' => 'Pearl Shape',
    'PearlStringingMethod' => 'Pearl Stringing Method',
    'PearlSurfaceBlemishes' => 'Pearl Surface Blemishes',
    'PearlType' => 'Pearl Type',
    'PearlUniformity' => 'Pearl Uniformity',
    'PhoneNumber' => 'Phone Number',
    'PhotoFlashType' => 'Photo Flash Type',
    'PictureFormat' => 'Picture Format',
    'Platform' => 'Platform',
    'PostalCode' => 'Postal Code',
    'PriceRating' => 'Price Rating',
    'ProcessorCount' => 'Processor Count',
    'ProductGroup' => 'Product Group',
    'PublicationDate' => 'Publication Date',
    'Publisher' => 'Publisher',
    'ReadingLevel' => 'Reading Level',
    'RegionCode' => 'Region Code',
    'ReleaseDate' => 'Release Date',
    'RemovableMemory' => 'Removable Memory',
    'ResolutionModes' => 'Resolution Modes',
    'RingSize' => 'Ring Size',
    'Role' => 'Role',
    'RunningTime' => 'Running Time',
    'SeasonSequence' => 'SeasonS equence',
    'SecondaryCacheSize' => 'Secondary Cache Size',
    'SettingType' => 'Setting Type',
    'ShortSynopsis' => 'Short Synopsis',
    'Size' => 'Size',
    'SizePerPearl' => 'Size Per Pearl',
    'SKU' => 'SKU',
    'SoundCardDescription' => 'Sound Card Description',
    'SpeakerDescription' => 'Speaker Description',
    'SpecialFeatures' => 'Special Features',
    'StartYear' => 'Start Year',
    'State' => 'State',
    'StoneClarity' => 'Stone Clarity',
    'StoneColor' => 'Stone Color',
    'StoneCut' => 'Stone Cut',
    'StoneShape' => 'Stone Shape',
    'StoneWeight' => 'Stone Weight',
    'Studio' => 'Studio',
    'SubscriptionLength' => 'Subscription Length',
    'SupportedImageType' => 'Supported Image Type',
    'SystemBusSpeed' => 'System Bus Speed',
    'SystemMemorySize' => 'System Memory Size',
    'SystemMemorySizeMax' => 'System Memory Size Max',
    'SystemMemoryType' => 'System Memory Type',
    'TheatricalReleaseDate' => 'Theatrical Release Date',
    'Title' => 'Title',
    'TotalDiamondWeight' => 'Total Diamond Weight',
    'TotalExternalBaysFree' => 'Total External Bays Free',
    'TotalFirewirePorts' => 'Total Firewire Ports',
    'TotalGemWeight' => 'Total Gem Weight',
    'TotalInternalBaysFree' => 'Total Internal Bays Free',
    'TotalMetalWeight' => 'Total Metal Weight',
    'TotalNTSCPALPorts' => 'Total NTSC/PAL Ports',
    'TotalPages' => 'Total Pages',
    'TotalParallelPorts' => 'Total Parallel Ports',
    'TotalPCCardSlots' => 'Total PC Card Slots',
    'TotalPCISlotsFree' => 'Total PCI Slots Free',
    'TotalResults' => 'Total Results',
    'TotalSerialPorts' => 'Total Serial Ports',
    'TotalSVideoOutPorts' => 'Total S-Video Out Ports',
    'TotalUSBPorts' => 'Total USB Ports',
    'TotalUSB2Ports' => 'Total USB2 Ports',
    'TotalVGAOutPorts' => 'Total VGA Out Ports',
    'TradeInValue' => 'Trade In Value',
    'Type' => 'Type',
    'Unit' => 'Unit',
    'UPC' => 'UPC',
    'VariationDenomination' => 'Variation Denomination',
    'VariationDescription' => 'Variation Description',
    'Warranty' => 'Warranty',
    'WatchMovementType' => 'Watch Movement Type',
    'WaterResistanceDepth' => 'Water Resistance Depth',
    'Weight' => 'Weight',
    'Width' => 'Width'
);


if (key_exists('item_id', $_GET)) {
    detail_page($_GET['item_id']);
} else {
    list_page();
}

function list_page() {

    global $ItemAttributes;
    ?>

    <div class="d_list">

        <?php if (strlen(get_option('amazon_shop_title')) > 0) { ?><h2><?php echo get_option('amazon_shop_title'); ?></h2><?php } ?>
        <?php
        $page = key_exists('shop_page', $_GET) ? $_GET['shop_page'] : 1;

        if (key_exists('page_id', $_GET)) { //the blog uses no URL rewriting, and the shop is on a secondary page
            $link = get_bloginfo('url') . "?page_id=" . $_GET['page_id'] . "&shop_page=";
        } elseif (!key_exists('page_id', $_GET) && strstr($_SERVER['REQUEST_URI'], "index.php")) { //the blog uses no URL rewriting, and the shop is on the homepage
            $link = get_bloginfo('url') . "/index.php" . $_SERVER['PATH_INFO'] . "?shop_page=";
        } else { //the blog uses URL rewriting
            $link = get_bloginfo('url') . str_replace("?shop_page=" . $page, "", $_SERVER['REQUEST_URI']) . "?shop_page=";
        }

        list($response, $NoItems) = find_match(get_option('amazon_keywords'), get_option('amazon_section'), get_option('amazon_locale'), $page, false);
        $pagination = pagination($NoItems, 10, $page, 3, $link, "&#9668;", "&#9658;", "", "<em>...</em>");
        ?>
        <br />
        <div class="d_pag">
            <!-- pagination -->
            <form name="pagination-forum" action="" method="post">
                <table width="100%" cellspacing="0" cellpadding="0" border="0">	
                    <tr>
                        <td><em>Page:</em> <?php echo $pagination[0]; ?></td>
                        <td nowrap="nowrap" width="1%"> 				
                            <em><?php echo $pagination[1] + 1; ?> to <?php echo $pagination[2]; ?> of <strong><?php echo $NoItems; ?></strong></em>
                        </td>					
                    </tr>	
                </table>
            </form>
            <!-- end pagination -->
        </div>
        <?php
        if (is_array($response)) {
            echo '<table class="t_shop" cellpadding="0" cellspacing="0">';
            $i = 0;
            foreach ($response as $item) {
                if ($item['EAN']) {
                    if ($item['Width'] >= $item['Height']) {
                        $style = 'width:' . get_option('amazon_th_width') . 'px';
                    }
                    if ($item['Height'] > $item['Width']) {
                        $style = 'height:' . get_option('amazon_th_height') . 'px';
                    }

                    $detail_link = key_exists('shop_page', $_GET) > 0 ? $_SERVER['REQUEST_URI'] . '&item_id=' . $item['EAN'] : $_SERVER['REQUEST_URI'] . '?item_id=' . $item['EAN'];

                    if ($i % get_option('amazon_table_cols') == 0)
                        echo "<tr>";

                    echo "	<td width='1%'><a href=\"$detail_link\"><img alt=\"$item[Title]\" style=\"" . $style . "\" src=\"$item[Image]\" /></a></td>
        								<td>
        									 <a href=\"$detail_link\">$item[Title]</a><br />
        	                            	<b>$item[Price]</b>:&nbsp;$item[Rating]/5.0  - $item[Reviews] reviews<br />
        	                     ";
                    foreach ($item['Extra'] as $attr => $value) {
                        if (is_array($value)) {
                            $value = implode(", ", $value);
                        }
                        echo "<strong>$ItemAttributes[$attr]</strong>: $value<br />";
                    }
                    echo "</td>";
                    if (($i - 1) % get_option('amazon_table_cols') == 0)
                        echo "</tr>";
                    $i++;
                }
            }
            echo '</table>';
        }
        ?>
        <div class="d_pag">
            <!-- pagination -->
            <form name="pagination-forum" action="" method="post">
                <table width="90%" cellspacing="0" cellpadding="0" border="0">	
                    <tr>
                        <td><em>Page:</em> <?php echo $pagination[0]; ?></td>
                        <td nowrap="nowrap" width="1%"> 				
                            <em><?php echo $pagination[1] + 1; ?> to <?php echo $pagination[2]; ?> of <strong><?php echo $NoItems; ?></strong></em>
                        </td>					
                    </tr>	
                </table>
            </form>
            <!-- end pagination -->
        </div>
        <p class="p_powered"><a href="http://www.winwinhost.com/">Amazon Affiliate System</a> powered by <a href="http://www.winwinhost.com/">WinWinHost.com</a></p>
    </div>
    <br clear="both" />
    <?php
}

function detail_page($ean) {
    list($response, $NoItems) = find_match($ean, get_option('amazon_section'), get_option('amazon_locale'), 1, true);
    global $ItemAttributes;
    ?>	

    <div class="d_detail">

        <h2><?php echo $response[0]['Title']; ?></h2>
        <br /><br />
        <a onclick="window.open('<?php echo $response[0]['LargeImage']; ?>','<?php echo $response[0]['Title']; ?>','menubar=no,width=<?php echo $response[0]['LargeImageWidth']; ?>,height=<?php echo $response[0]['LargeImageWidth']; ?>,toolbar=no');" href="javascript:void(0)"><img alt="<?php echo $response[0]['Title']; ?>" style="float:left;margin:0 10px 10px 0" src="<?php echo $response[0]['Image']; ?>" /></a>
        <b>Price</b>: <?php echo $response[0]['Price']; ?>
        <br />
        <a target="_blank" href="<?php echo $response[0]['Detail']; ?>">Go to Amazon Detail Page</a><br />
        <!--<a href="<?php echo $response[0]['Detail']; ?>">test</a>-->
        <br /><br />
        <?php
        foreach ($response[0]['Extra'] as $key => $value) {
            if (is_array($value)) {
                $value = implode(", ", $value);
            }
            echo '<b>' . $ItemAttributes[$key] . '</b>: ' . $value . '<br />';
        }
        ?>
        <br clear="both" />
        <p style="text-align:center;border-top:1px solid #ccc"><a href="http://www.winwinhost.com/">Amazon Affiliate System</a> powered by <a href="http://www.winwinhost.com/">WinWinHost.com</a></p>
    </div>
    <br clear="both" />
    <?php
}

function find_match($search, $section = "All", $locale = 'US', $page = 1, $detail = false) {

    require_once 'Amazon.class.php';
    
    $client = new Amazon(array(
        'api' => get_option('key_id'),
        'secret' => get_option('secret_key'),
        'tag' => get_option('assoc_tag'),
    ));
    
   $response = $client->ItemSearch($search, $section, $locale, array (
				"ResponseGroup"=>"Large",
				"ItemPage"=>$page
				));
    
    //If its an array, we have multiple items. If its an object, its a single object.
    //Create a slimmed down array from the reponse w/ the stuff I want in it.
    $extra = array();
    $toReturn = null;
    if (is_object($response->Items->Item) && !$detail) {
        foreach ($response->Items->Item as $item) {

            foreach ($item->ItemAttributes as $attr => $value) {
                if (in_array($attr, array(get_option('amazon_list_attribute1'), get_option('amazon_list_attribute2'), get_option('amazon_list_attribute3'), get_option('amazon_list_attribute4')))) {
                    $extra[$attr] = $value;
                }
            }
            if (isset($item->OfferSummary->LowestNewPrice->FormattedPrice)) {
                $price = $item->OfferSummary->LowestNewPrice->FormattedPrice;
            } else {
                $price = $item->ItemAttributes->ListPrice->FormattedPrice;
            }
            $toReturn[] = array(
                "Image" => $item->MediumImage->URL,
                "Height" => $item->MediumImage->Height,
                "Width" => $item->MediumImage->Width,
                "Detail" => $item->DetailPageURL,
                "Title" => $item->ItemAttributes->Title,
                "Rating" => $item->CustomerReviews->AverageRating,
                "Reviews" => $item->CustomerReviews->TotalReviews,
                "Price" => $price,
                "EAN" => $item->ItemAttributes->EAN,
                "Extra" => $extra
            );
        }
    } elseif (is_object($response->Items->Item) && $detail) {
        $item = $response->Items->Item;
        foreach ($item->ItemAttributes as $attr => $value) {
            if (in_array($attr, unserialize(get_option('amazon_itemattributes')))) {
                $extra[$attr] = $value;
            }
        }

        if (isset($item->OfferSummary->LowestNewPrice->FormattedPrice)) {
            $price = $item->OfferSummary->LowestNewPrice->FormattedPrice;
        } else {
            $price = $item->ItemAttributes->ListPrice->FormattedPrice;
        }

        $toReturn[] = array(
            "LargeImage" => $item->LargeImage->URL,
            "LargeImageHeight" => $item->LargeImage->Height->_,
            "LargeImageWidth" => $item->LargeImage->Width->_,
            "Image" => $item->MediumImage->URL,
            "Height" => $item->MediumImage->Height,
            "Width" => $item->MediumImage->Width,
            "Detail" => $item->DetailPageURL,
            "Title" => $item->ItemAttributes->Title,
            "Rating" => $item->CustomerReviews->AverageRating,
            "Reviews" => $item->CustomerReviews->TotalReviews,
            "Price" => $price,
            "EAN" => $item->ItemAttributes->EAN,
            "Extra" => $extra
        );
    }

    return array(
        $toReturn,
        $response->Items->TotalResults
    );
}

function pagination($total, $noPerPage, $page, $interval, $link, $previous, $next, $spacing, $missing, $actLink = "class=\"act\"", $inactLink = "") {
    $var = "page";
    $page = gettype($page + 0) == "integer" ? $page : 1;
    $pages = array();
    $pages[0] = "";
    if ($total > 0) {
        $noPages = floor($total / $noPerPage);
        $noPages += ($noPages * $noPerPage < $total) ? 1 : 0;
        $page = $page > $noPages ? $noPages : $page;
        $intervalMin = ($page - $interval) < 1 ? 1 : ($page - $interval);
        $intervalMax = ($page + $interval) > $noPages ? ($noPages) : ($page + $interval);
        if ($page > 1)
            $pages[0] .= "<a href=\"$link" . ($page - 1) . "\" " . $inactLink . ">$previous</a> ";
        if ($intervalMin > 1)
            $pages[0] .= " <a href=\"" . $link . "1\" " . $inactLink . ">1</a> ";
        if ($intervalMin == 2)
            $pages[0] .= $spacing;
        if ($intervalMin > 2)
            $pages[0] .= $missing;
        for ($i = $intervalMin; $i <= $intervalMax; $i++) {
            if ($i == $page)
                $pages[0] .= " <a href=\"\" onclick=\"return false;\" " . $actLink . ">$i</a> ";
            else
                $pages[0] .= " <a href=\"$link$i\" " . $inactLink . ">$i</a> ";
            if ($i < $intervalMax)
                $pages[0] .= $spacing;
            else if ($intervalMax + 1 == $noPages)
                $pages[0] .= $spacing;
        }
        if ($intervalMax < $noPages - 1)
            $pages[0] .= $missing;
        if ($intervalMax < $noPages)
            $pages[0] .= " <a href=\"$link$noPages\" " . $inactLink . ">$noPages</a> ";
        if ($page < $noPages)
            $pages[0] .= " <a href=\"$link" . ($page + 1) . "/\" " . $inactLink . ">$next</a> ";
        $pages[1] = ($page - 1) * $noPerPage;

        $pages[2] = $page * $noPerPage > $total ? $total : $page * $noPerPage;
    }else {
        $pages[0] = "";
    }
    return $pages;
}